// VirtueMart Cart JavaScript
jQuery(function () {
    OverrideThirdPartyAddToCartPopups();
});

// Override Facebox and fancyBox dependencies of VM for add to cart popup option and replace with our own
function OverrideThirdPartyAddToCartPopups() {

    // Simple guard for non-VirtueMart pages
    if (typeof Virtuemart === "undefined") return;
    if (typeof Virtuemart.cartEffect !== "function") return;

    const cartUriNonSef = Virtuemart.vmSiteurl + "index.php?option=com_virtuemart&view=cart";
    const cartUri = Joomla.getOptions("tpl_airis").vmCartUri ? Joomla.getOptions("tpl_airis").vmCartUri : cartUriNonSef;
    const useBootstrapToasts = Boolean(Joomla.getOptions("tpl_airis").useBootstrapToastsAsVirtuemartCartNotifications);

    if (useBootstrapToasts) {
        // Declaring it as a var here so it stays accessible from the DisplayProductAddErrorMessage() nested function
        var toastLinkReloadPageHtml = "<a href=\"javascript:location.reload();\" class=\"airis__toast-link\">" + Joomla.JText._("TPL_AIRIS_RELOAD_PAGE") + "</a>";
    }

    Virtuemart.cartEffect = function (addToCartForm) {
        jQuery.ajax({
            url: cartUriNonSef + "&nosef=1&task=addJS&format=json" + Virtuemart.vmLang + window.Itemid,
            data: addToCartForm.serialize(),
            dataType: "json",
            method: "POST"
        }).done(function (response) {

            // Select a proper newline character sequence based on whether we're using the browser API or HTML for user notifications
            const newLineString = useBootstrapToasts ? "<br>" : "\n";
            const responseMessage = JSON.parse(response.msg);

            switch (response.stat) {

                case "1":
                // No break
                case "2":

                    let addedProductsStatusText = "";
                    const numUniqueProductsAdded = typeof responseMessage.products !== "undefined" ? responseMessage.products.length : 0;
                    let errorHappened = false;

                    if (numUniqueProductsAdded > 0) {

                        for (let i = 0; i < numUniqueProductsAdded; i++) {
                            if (responseMessage.products[i].errorMessage) {
                                errorHappened = true;

                                // Proper newline placement if multiple unique products are added at the same time
                                if (addedProductsStatusText) {
                                    addedProductsStatusText += newLineString;
                                }

                                addedProductsStatusText += String(responseMessage.products[i].errorMessage).replace("<i>", "«").replace("</i>", "»");

                                if (i < numUniqueProductsAdded - 1) {
                                    addedProductsStatusText += newLineString;
                                }
                            } else {

                                // Proper newline placement if multiple unique products have errors
                                if (addedProductsStatusText) {
                                    addedProductsStatusText += newLineString;
                                }

                                addedProductsStatusText += responseMessage.products[i].statusMessage;

                                if (i < numUniqueProductsAdded - 1) {
                                    addedProductsStatusText += newLineString;
                                }
                            }
                        }
                    } else {
                        addedProductsStatusText = String(responseMessage.errorMessages).replace("<i>", "«").replace("</i>", "»");
                        errorHappened = true;
                    }

                    if (addedProductsStatusText) {

                        // Do not offer navigation to shopping cart if there were any errors with adding products
                        if (errorHappened) {
                            if (useBootstrapToasts) {
                                CreateBootstrapToast(addedProductsStatusText);
                            } else {
                                alert(addedProductsStatusText);
                            }
                        } else {
                            if (useBootstrapToasts) {
                                CreateBootstrapToast(Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_CART_PRODUCT_ADDED_SHORT") + " " + "<a href=\"" + cartUri + "\" class=\"airis__toast-link\">" + Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_CART_PRODUCT_ADDED_CART_LINK_TITLE") + "</a>");
                            } else {
                                // Use additional spacing for multiline strings
                                if (addedProductsStatusText.indexOf(newLineString) !== -1) {
                                    addedProductsStatusText += newLineString + newLineString;
                                }

                                addedProductsStatusText += " " + Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_CONFIRM_SHOW_CART");

                                // Offer navigation to shopping cart
                                if (confirm(addedProductsStatusText)) {
                                    location.href = cartUri;
                                }
                            }
                        }
                    } else {
                        DisplayProductAddErrorMessage();
                    }

                    break;

                default:

                    let addedProductsErrorMessages = "";
                    let composedErrorMessage = "";
                    const numErrorMessages = responseMessage.errorMessages.length;

                    for (let i = 0; i < numErrorMessages; i++) {
                        // Proper newline placement for multiple error messages
                        if (addedProductsErrorMessages) {
                            addedProductsErrorMessages += newLineString;
                        }

                        addedProductsErrorMessages += responseMessage.errorMessages[i];

                        if (i < numErrorMessages - 1) {
                            addedProductsErrorMessages += newLineString;
                        }
                    }

                    composedErrorMessage = Virtuemart.vmCartError + "." + newLineString + newLineString + addedProductsErrorMessages;

                    if (useBootstrapToasts) {
                        CreateBootstrapToast(composedErrorMessage + newLineString + newLineString + toastLinkReloadPageHtml);
                    } else {
                        alert(composedErrorMessage);
                        location.reload();
                    }

                    break;
            }

            document.body.dispatchEvent(new Event("updateVirtueMartCartModule", { bubbles: true }));

        }).fail(function () { DisplayProductAddErrorMessage(); });
    };

    function DisplayProductAddErrorMessage() {

        const errorMessage = Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_ALERT_PRODUCT_ADD_ERROR");

        if (useBootstrapToasts) {
            CreateBootstrapToast(errorMessage + " " + toastLinkReloadPageHtml);
        } else {
            alert(errorMessage);
            location.reload();
        }
    }
}