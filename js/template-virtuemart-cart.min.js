// VirtueMart Cart JavaScript
jQuery(document).on("ready", function () {
	RemoveThirdPartyAddToCartPopups();
});

// Remove Facebox and fancybox dependencies for add to cart popup option
function RemoveThirdPartyAddToCartPopups() {

	// Simple guard for non-VirtueMart pages
	if (typeof Virtuemart === "undefined") return;
	if (typeof Virtuemart.cartEffect !== "function") return;

	Virtuemart.cartEffect = function (addToCartForm) {
		jQuery.ajax({
			url: Virtuemart.vmSiteurl + "index.php?option=com_virtuemart&view=cart&nosef=1&task=addJS&format=json" + Virtuemart.vmLang + window.Itemid,
			data: addToCartForm.serialize(),
			dataType: "json",
			method: "POST"
		}).done(function (response) {

			var responseMessage = JSON.parse(response.msg);

			switch (response.stat) {

				case "1":
				case "2":

					var addedProductsStatusText = "";
					var numUniqueProductsAdded = typeof responseMessage.products !== "undefined" ? responseMessage.products.length : 0;
					var errorHappened = false;

					if (numUniqueProductsAdded > 0) {

						for (var i = 0; i < numUniqueProductsAdded; i++) {

							if (responseMessage.products[i].errorMessage) {

								if (!errorHappened) errorHappened = true;

								// Proper newline placement if multiple unique products are added at the same time
								if (addedProductsStatusText) addedProductsStatusText += "\n";
								addedProductsStatusText += String(responseMessage.products[i].errorMessage).replace("<i>", "«").replace("</i>", "»");
								if (i < numUniqueProductsAdded - 1) addedProductsStatusText += "\n";

							} else {

								// Proper newline placement if multiple unique products have errors
								if (addedProductsStatusText) addedProductsStatusText += "\n";
								addedProductsStatusText += responseMessage.products[i].statusMessage;
								if (i < numUniqueProductsAdded - 1) addedProductsStatusText += "\n";
							}
						}
					} else {
						addedProductsStatusText = String(responseMessage.errorMessages).replace("<i>", "«").replace("</i>", "»");
						errorHappened = true;
					}

					if (addedProductsStatusText) {

						// Do not offer navigation to shopping cart if there were any errors with adding products
						if (errorHappened) {
							alert(addedProductsStatusText);
						} else {

							// Use additional spacing for multiline strings
							if (addedProductsStatusText.indexOf("\n") != -1) addedProductsStatusText += "\n\n";
							addedProductsStatusText += " " + Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_CONFIRM_SHOW_CART");

							// Offer navigation to shopping cart
							if (confirm(addedProductsStatusText)) location.href = "/index.php?option=com_virtuemart&view=cart";
						}
					} else {
						alert(Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_ALERT_PRODUCT_ADD_ERROR"));
						location.reload();
					}

					break;

				default:

					var addedProductsErrorMessages = "";
					var numErrorMessages = responseMessage.errorMessages.length;

					for (var i = 0; i < numErrorMessages; i++) {

						// Proper newline placement for multiple error messages
						if (addedProductsErrorMessages) addedProductsErrorMessages += "\n";
						addedProductsErrorMessages += responseMessage.errorMessages[i];
						if (i < numErrorMessages - 1) addedProductsErrorMessages += "\n";
					}

					alert(Virtuemart.vmCartError + ".\n\n" + addedProductsErrorMessages);
					location.reload();
			}

			jQuery("body").trigger("updateVirtueMartCartModule");

		}).fail(function () {
			alert(Joomla.JText._("TPL_AIRIS_COM_VIRTUEMART_ALERT_PRODUCT_ADD_ERROR"));
		});
	};
}