// Generic Airis JavaScript
jQuery(document).on("ready", function () {

	AddRussianLocalizationForFancybox();

	ApplyStandaloneFancybox3ToSigplusGalleries();

	CreateResponsiveMainMenuSubmenuToggleButtons();

});

function AddRussianLocalizationForFancybox() {

	if (jQuery.fancybox && jQuery("html").attr("lang").indexOf("ru") === 0) {

		jQuery.fancybox.defaults.i18n.ru = {
			CLOSE: "Закрыть",
			NEXT: "Следующий элемент",
			PREV: "Предыдущий элемент",
			ERROR: "Ошибка загрузки содержимого. <br/> Попробуйте повторить позже.",
			PLAY_START: "Начать слайд-шоу",
			PLAY_STOP: "Приостановить слайд-шоу",
			FULL_SCREEN: "Полноэкранный режим",
			THUMBS: "Эскизы",
			DOWNLOAD: "Скачать",
			SHARE: "Поделиться",
			ZOOM: "Масштаб"
		}

		jQuery.fancybox.defaults.lang = "ru";
	}
}

function ApplyStandaloneFancybox3ToSigplusGalleries() {

	if (jQuery.fancybox) {

		var $sigplusImageFancyboxCaptionsCreated = false;

		jQuery(".sigplus-gallery").on("click", ".sigplus-image", function () {

			// Create fancyBox captions for sigplus images acquired from its labels.txt file
			if (!$sigplusImageFancyboxCaptionsCreated) {

				var $sigplusImagesWithTitle = jQuery(".sigplus-image[title]");

				if ($sigplusImagesWithTitle.length) {
					$sigplusImagesWithTitle.each(function () {
						var $currentSigplusImageWithTitle = jQuery(this);
						$currentSigplusImageWithTitle.attr("data-caption", $currentSigplusImageWithTitle.attr("title"));
					});

					$sigplusImageFancyboxCaptionsCreated = true;
				}
			}

			var $currentSigplusImage = jQuery(this);

			jQuery.fancybox.open($currentSigplusImage.parents(".sigplus-gallery").first().find(".sigplus-image"), null, $currentSigplusImage.parent().index());
		});

	} else {

		jQuery(".sigplus-gallery").on("click", ".sigplus-image", function () {
			window.open(this.href);
		});

		console.log("fancyBox not loaded.");
	}
}

function CreateResponsiveMainMenuSubmenuToggleButtons() {

	var $parentMenuItem = jQuery(".navbar .parent").not(".has-nav-child-toggle-link");
	if (!$parentMenuItem.length) return;

	$parentMenuItem.addClass("has-nav-child-toggle-link");

	var $parentMenuItemLink = $parentMenuItem.children("a");
	var toggleButtonIconClass = Joomla.getOptions("tpl_airis").useFontAwesome ? "fas fa-chevron-down" : "airis-chevron airis-chevron-bottom";
	var toggleButtonHtml = "<div class=\"nav-child-toggle\"><a class=\"nav-child-toggle-link\" title=\"" + Joomla.JText._("TPL_AIRIS_MAIN_MENU_CHILD_MENU_TOGGLE_BTN_TITLE") + "\"><span class=\"" + toggleButtonIconClass + "\" aria-hidden=\"true\"></span></a></div>";

	$parentMenuItemLink.after(toggleButtonHtml);

	$parentMenuItemLink.next(".nav-child-toggle").children(".nav-child-toggle-link").on("click", function () {
		jQuery(this).toggleClass("nav-child-toggle-link-active").parent().next().toggleClass("nav-child-displayed");
	});
}

function DisplayMenuItemInFancybox(itemId, modalHeight, modalWidth, autoFocus, modalClass) {

	// Menu item IDs start with 101
	if (!itemId || !parseInt(itemId) || itemId <= 100) {
		console.log("Incorrect Itemid.");
		return;
	}

	if (!jQuery.fancybox) {
		console.log("fancyBox not loaded.");
		return;
	}

	// Apply certain defaults if required
	if (!modalHeight || !parseFloat(modalHeight)) modalHeight = 24;
	if (!modalWidth || !parseFloat(modalWidth)) modalWidth = 32;
	if (typeof autoFocus !== "boolean") autoFocus = true;

	// Suitable for additional stying and scripting
	if (!modalClass) modalClass = "airis-lightbox-iframe";

	jQuery.fancybox.open({
		src: "/index.php?Itemid=" + itemId + "&tmpl=component",
		type: "iframe",
		autoFocus: autoFocus,
		baseClass: modalClass,
		smallBtn: true,
		iframe: {
			preload: false,
			css: {
				width: modalWidth + "rem",
				height: modalHeight + "rem"
			}
		}
	});
}

function DisplayMenuItemAliasInFancybox(itemAlias, modalHeight, modalWidth, autoFocus, modalClass) {

	if (typeof itemAlias !== "string" || !itemAlias.length) {
		console.log("Incorrect item alias.");
		return;
	}

	if (!jQuery.fancybox) {
		console.log("fancyBox not loaded.");
		return;
	}

	if (!modalHeight || !parseFloat(modalHeight)) modalHeight = 24;
	if (!modalWidth || !parseFloat(modalWidth)) modalWidth = 32;
	if (typeof autoFocus !== "boolean") autoFocus = true;
	if (!modalClass) modalClass = "airis-lightbox-iframe";

	jQuery.fancybox.open({
		src: "/" + itemAlias + "?tmpl=component",
		type: "iframe",
		autoFocus: autoFocus,
		baseClass: modalClass,
		smallBtn: true,
		iframe: {
			preload: false,
			css: {
				width: modalWidth + "rem",
				height: modalHeight + "rem"
			}
		}
	});
}

function DisplayArticleInFancybox(articleId, modalClass) {

	// Article IDs start with 1
	if (!articleId || !parseInt(articleId) || articleId <= 0) {
		console.log("Incorrect article ID.");
		return;
	}

	if (!jQuery.fancybox) {
		console.log("fancyBox not loaded.");
		return;
	}

	if (!modalClass) modalClass = "airis-lightbox-article";

	jQuery.get("/index.php", { option: "com_content", view: "article", id: articleId, tmpl: "component" }).done(function (data) {

		var $articleContent = jQuery(data).find(".item-page");

		if ($articleContent.length) {

			jQuery.fancybox.open({
				src: $articleContent,
				type: "html",
				autoFocus: false,
				baseClass: modalClass
			});

		} else {
			console.log("Article ID " + articleId + " has no content.");
		}

	}).fail(function () {
		console.log("Unable to request article ID " + articleId + ".");
	});
}

function CreateDoubleGisWidgetMap(containerId, mapLatitude, mapLongitude, mapOrganizationId, mapCity, mapBorderColor, mapWidth, mapHeight, mapZoomLevel) {

	if (typeof DGWidgetLoader === "undefined") {
		console.log("DGWidgetLoader not found.");
		return;
	}

	if (!containerId) return;

	var $mapContainer = jQuery(containerId);
	if (!$mapContainer.length) return;

	if (!mapBorderColor) mapBorderColor = "#a3a3a3";
	if (!mapWidth) mapWidth = "100%";
	if (!mapHeight) mapHeight = 400;
	if (!mapZoomLevel) mapZoomLevel = 16;

	var mapHtml;

	// DGWidgetLoader() uses document.write() which is not supported with deferred script loading so it is required to capture all output by temporarily redefining the method
	var documentWriteTempHandler = document.write;

	document.write = function (widgetOutput) {
		mapHtml = widgetOutput;
	}

	new DGWidgetLoader({
		"width": mapWidth,
		"height": mapHeight,
		"borderColor": mapBorderColor,
		"pos": {
			"lat": mapLatitude,
			"lon": mapLongitude,
			"zoom": mapZoomLevel
		},
		"opt": {
			"city": mapCity
		},
		"org": [{
			"id": mapOrganizationId
		}]
	});

	$mapContainer.append(mapHtml);

	document.write = documentWriteTempHandler;
}